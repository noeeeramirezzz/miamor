<%= form_with model: asignacion, url: form_url, local: true do |form| %>

  <!-- EVENTO + ESTADO -->
  <div class="row">
    <div class="col-md-6 mb-3">
      <%= form.label :evento_id, "Evento" %>
      <%= form.collection_select :evento_id, Evento.all, :id, :nombre_evento,
                                 { include_blank: "Seleccione un evento" },
                                 class: "form-select" %>
    </div>

    <div class="col-md-6 mb-3">
      <%= form.label :estado, "Estado General" %>
      <%= form.select :estado, ["Planificada", "En Proceso", "Finalizada"],
                      { include_blank: "Seleccione un estado" },
                      class: "form-select" %>
    </div>
  </div>

  <h4 class="mt-4">Asignación de Servicios</h4>

  <table class="table table-bordered">
    <thead>
    <tr>
      <th>Servicio</th>
      <th>Empleado</th>
      <th>Tarea</th>
      <th></th>
    </tr>
    </thead>

    <tbody id="asignaciones-container">

    <!-- DETALLES EXISTENTES -->
    <%= form.fields_for :asignacion_detalles do |detalle| %>
      <%= render "asignacion_fields", f: detalle %>
    <% end %>

    </tbody>
  </table>

  <!-- BOTÓN PARA AGREGAR -->
  <%= link_to "Agregar servicio", "#", id: "add-asignacion", class: "btn btn-success" %>

  <!-- TEMPLATE PARA NUEVAS FILAS -->
  <script type="text/template" id="asignaciones_template">
    <%= form.fields_for :asignacion_detalles, AsignacionDetalle.new, child_index: "NEW_RECORD" do |detalle| %>
      <%= render "asignacion_fields", f: detalle %>
    <% end %>
  </script>

  <div class="mt-3">
    <%= form.submit "Guardar", class: "btn btn-primary" %>
  </div>

<% end %>

<!-- ============================
      JAVASCRIPT DEL FORM
     ============================ -->

<script>
    // ------------------------------
    // CARGAR EMPLEADOS POR SERVICIO
    // ------------------------------
    async function cargarEmpleados(servicioId, selectEmpleado, seleccionado = null) {

        const respServ = await fetch(`/servicios/${servicioId}.json`);
        const servicio = await respServ.json();
        const categoria = servicio.categoria;

        if (!categoria) {
            selectEmpleado.innerHTML = '<option value="">Sin empleados disponibles</option>';
            return;
        }

        const respEmp = await fetch(`/empleados/por_categoria?categoria=${encodeURIComponent(categoria)}`);
        const empleados = await respEmp.json();

        selectEmpleado.innerHTML = '<option value="">Seleccione empleado</option>';

        empleados.forEach(emp => {
            const opt = document.createElement("option");
            opt.value = emp.id;
            opt.textContent = emp.nombre;

            if (seleccionado && seleccionado == emp.id) {
                opt.selected = true;
            }

            selectEmpleado.appendChild(opt);
        });
    }

    // ------------------------------
    // AGREGAR NUEVAS FILAS
    // ------------------------------
    document.addEventListener("click", e => {

        // agregar fila
        if (e.target.id === "add-asignacion") {
            e.preventDefault();
            const html = document.querySelector("#asignaciones_template").innerHTML;
            document.querySelector("#asignaciones-container").insertAdjacentHTML("beforeend", html);
        }

        // borrar fila
        if (e.target.classList.contains("remove_fields")) {
            e.target.closest(".nested-fields").remove();
        }
    });

    // ------------------------------
    // CARGAR EMPLEADOS AL CAMBIAR SERVICIO
    // ------------------------------
    document.addEventListener("change", async function (e) {

        if (!e.target.classList.contains("select-servicio")) return;

        const fila = e.target.closest("tr");
        const servicioId = e.target.value;
        const selectEmpleado = fila.querySelector(".select-empleado");

        if (!servicioId) {
            selectEmpleado.innerHTML = '<option value="">Seleccione empleado</option>';
            return;
        }

        await cargarEmpleados(servicioId, selectEmpleado);
    });

    // ------------------------------
    // PRECARGA AUTOMÁTICA PARA EDICIÓN
    // ------------------------------
    document.addEventListener("DOMContentLoaded", () => {

        document.querySelectorAll(".nested-fields").forEach(async row => {

            const servicioSelect = row.querySelector(".select-servicio");
            const empleadoSelect = row.querySelector(".select-empleado");

            const servicioId = servicioSelect.value;
            const seleccionado = empleadoSelect.dataset.selected;

            if (servicioId) {
                await cargarEmpleados(servicioId, empleadoSelect, seleccionado);
            }
        });
    });
</script>
