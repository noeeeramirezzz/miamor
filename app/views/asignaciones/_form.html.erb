<%= form_with model: asignacion, url: form_url, local: true do |form| %>

  <!-- EVENTO + ESTADO GENERAL -->
  <div class="row">
    <div class="col-md-6 mb-3">
      <%= form.label :evento_id, "Evento", class: "form-label" %>
      <%= form.collection_select :evento_id, Evento.all, :id, :nombre_evento,
                                 { include_blank: "Seleccione un evento" },
                                 class: "form-select", required: true %>
    </div>

    <div class="col-md-6 mb-3">
      <%= form.label :estado, "Estado General", class: "form-label" %>
      <%= form.select :estado, ["Planificada", "En Proceso", "Finalizada"],
                      { include_blank: "Seleccione un estado" },
                      class: "form-select", required: true %>
    </div>
  </div>

  <h4 class="mt-4">Asignaci√≥n de Servicios</h4>

  <table class="table table-bordered">
    <thead>
    <tr>
      <th>Servicio</th>
      <th>Empleado</th>
      <th>Tarea</th>
      <th></th>
    </tr>
    </thead>

    <tbody id="asignaciones-container">
    <!-- RENDERIZAR TODOS LOS DETALLES EXISTENTES -->
    <%= form.fields_for :asignacion_detalles do |detalle| %>
      <%= render "asignacion_fields", f: detalle %>
    <% end %>
    </tbody>
  </table>

  <%= link_to "Agregar servicio", "#", id: "add-asignacion", class: "btn btn-success" %>

  <!-- TEMPLATE PARA A√ëADIR FILAS -->
  <script type="text/template" id="asignaciones_template">
    <%= form.fields_for :asignacion_detalles, AsignacionDetalle.new, child_index: "NEW_RECORD" do |detalle| %>
      <%= render "asignacion_fields", f: detalle %>
    <% end %>
  </script>

  <div class="mt-3">
    <%= form.submit "Guardar", class: "btn btn-primary" %>
    <%= link_to "Cancelar", asignaciones_path, class: "btn btn-secondary ms-2" %>
  </div>

<% end %>

<script>
    // ‚ûï Agregar nuevas filas
    document.addEventListener("click", function(e) {
        if (e.target.id === "add-asignacion") {
            e.preventDefault();
            const template = document.querySelector("#asignaciones_template").innerHTML;
            document.querySelector("#asignaciones-container")
                .insertAdjacentHTML("beforeend", template);
        }

        // ‚ùå Eliminar filas
        if (e.target.classList.contains("remove_fields")) {
            e.target.closest(".nested-fields").remove();
        }
    });

    // üéØ Filtrar empleados seg√∫n servicio (para cada fila)
    document.addEventListener("change", function(e) {
        if (e.target.classList.contains("select-servicio")) {

            const servicioSelect = e.target;
            const row = servicioSelect.closest("tr");
            const empleadoSelect = row.querySelector(".select-empleado");

            const servicioId = servicioSelect.value;

            if (!servicioId) {
                empleadoSelect.innerHTML = '<option value="">Seleccione empleado</option>';
                return;
            }

            // 1) Obtener el servicio para saber su categor√≠a
            fetch(`/servicios/${servicioId}.json`)
                .then(resp => resp.json())
                .then(servicio => {
                    const categoria = servicio.categoria;

                    // 2) Pedir empleados por categor√≠a (string)
                    fetch(`/empleados/por_categoria?categoria=${encodeURIComponent(categoria)}`)
                        .then(resp => resp.json())
                        .then(data => {
                            empleadoSelect.innerHTML =
                                '<option value="">Seleccione empleado</option>';

                            data.forEach(emp => {
                                const opt = document.createElement("option");
                                opt.value = emp.id;
                                opt.text = emp.nombre;
                                empleadoSelect.appendChild(opt);
                            });
                        });
                });
        }
    });
</script>
